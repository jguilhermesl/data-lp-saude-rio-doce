// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  MANAGER
  VIEWER
}


// ============================================
// ENTIDADES PRINCIPAIS
// ============================================

/// Paciente
model Patient {
  id           String @id @default(uuid())
  externalId   String // código do sistema atual (hid_cod_paciente)
  sourceSystem String // identificador do sistema de origem

  // Dados do paciente
  fullName       String // nome completo
  motherName     String? // nome da mãe
  identityNumber String? // RG
  cpf            String?
  homePhone      String?
  mobilePhone    String?
  insuranceName  String? // convênio (razao_social)

  // Campos técnicos
  syncedAt   DateTime?
  rawPayload Json? // JSON opcional para debug/auditoria do ETL
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relações
  appointments Appointment[]

  @@unique([externalId, sourceSystem]) // garante upsert idempotente
  @@index([cpf])
  @@index([fullName])
  @@map("patients")
}

/// Médico
model Doctor {
  id           String @id @default(uuid())
  externalId   String // código médico no sistema atual (hid_cod_medico)
  sourceSystem String // identificador do sistema de origem

  // Dados do médico
  name        String // nome completo
  crm         String?
  homePhone   String? // telefone residencial
  workPhone   String? // telefone comercial
  mobilePhone String? // celular

  // Campos técnicos
  syncedAt   DateTime?
  rawPayload Json? // JSON opcional para debug/auditoria do ETL
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relações
  appointments      Appointment[]
  doctorSpecialties DoctorSpecialty[]

  @@unique([externalId, sourceSystem]) // garante upsert idempotente
  @@index([name])
  @@index([crm])
  @@map("doctors")
}

/// Especialidade
model Specialty {
  id           String @id @default(uuid())
  externalId   String // código da especialidade no sistema externo (hii_cod_especialidade)
  sourceSystem String // identificador do sistema de origem

  // Dados da especialidade
  name String // nome da especialidade

  // Campos técnicos
  syncedAt   DateTime?
  rawPayload Json? // JSON opcional para debug/auditoria do ETL
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relações
  doctorSpecialties DoctorSpecialty[]
  appointments      Appointment[]
  procedures        Procedure[]

  @@unique([externalId, sourceSystem], map: "specialty_external_unique")
  @@index([name])
  @@map("specialties")
}

/// Procedimento / Exame
model Procedure {
  id           String @id @default(uuid())
  externalId   String // código do procedimento no sistema externo (hid_cod_amb)
  sourceSystem String // identificador do sistema de origem

  // Dados do procedimento
  name         String // descrição do procedimento
  code         String? // sigla do procedimento
  defaultPrice Decimal? @db.Decimal(10, 2) // valor padrão (fnd_valor)
  ch           String? // campo CH do sistema externo

  // Relação com especialidade
  specialtyName String? // nome da especialidade (temporário até relacionar)
  specialtyId   String? // FK para especialidade

  // Campos técnicos
  syncedAt   DateTime?
  rawPayload Json? // JSON opcional para debug/auditoria do ETL
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relações
  specialty             Specialty?             @relation(fields: [specialtyId], references: [id], onDelete: SetNull)
  appointmentProcedures AppointmentProcedure[]

  @@unique([externalId, sourceSystem], map: "procedure_external_unique")
  @@index([name])
  @@index([code])
  @@index([specialtyId])
  @@map("procedures")
}

/// Atendimento
model Appointment {
  id           String @id @default(uuid())
  externalId   String // código atendimento no sistema atual
  sourceSystem String // identificador do sistema de origem

  // Dados do atendimento
  appointmentDate DateTime  @db.Date
  appointmentTime String? // hora do atendimento
  appointmentAt   DateTime? // timestamp completo (recomendado para queries)
  createdDate     DateTime? @db.Date

  // Convênio e valores
  insuranceName String? // convênio (texto por enquanto)
  examValue     Decimal? @db.Decimal(10, 2) // valor do exame
  paidValue     Decimal? @db.Decimal(10, 2) // valor pago
  paymentDone   Boolean  @default(false) // pagamento realizado

  // Exames (raw do sistema atual, caso venha como texto)
  examsRaw String? @db.Text

  // Chaves estrangeiras
  patientId         String?
  doctorId          String?
  responsibleUserId String?
  specialtyId       String? // opcional: especialidade principal do atendimento

  // Campos técnicos
  syncedAt   DateTime?
  rawPayload Json? // JSON opcional para debug/auditoria do ETL
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relações
  patient               Patient?               @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor                Doctor?                @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  responsibleUser       User?                  @relation(fields: [responsibleUserId], references: [id], onDelete: SetNull)
  specialty             Specialty?             @relation(fields: [specialtyId], references: [id], onDelete: SetNull)
  appointmentProcedures AppointmentProcedure[]

  @@unique([externalId, sourceSystem]) // garante upsert idempotente
  @@index([appointmentDate])
  @@index([patientId])
  @@index([doctorId])
  @@index([responsibleUserId])
  @@index([specialtyId])
  @@index([paymentDone])
  @@map("appointments")
}

/// Usuário do sistema (não vem do sistema da clínica)
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(VIEWER)

  // Dados do usuário
  name   String?
  phone  String?
  active Boolean @default(true)

  // Campos técnicos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  appointments Appointment[]

  @@index([email])
  @@map("users")
}

// ============================================
// TABELAS PIVÔ (N:N)
// ============================================

/// Relacionamento N:N entre Médico e Especialidade
model DoctorSpecialty {
  id          String @id @default(uuid())
  doctorId    String
  specialtyId String

  // Campos técnicos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  doctor    Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  specialty Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@unique([doctorId, specialtyId])
  @@index([doctorId])
  @@index([specialtyId])
  @@map("doctor_specialties")
}

/// Relacionamento N:N entre Atendimento e Procedimento
model AppointmentProcedure {
  id            String @id @default(uuid())
  appointmentId String
  procedureId   String

  // Dados opcionais do procedimento no atendimento
  quantity   Int?     @default(1)

  // Campos técnicos
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  procedure   Procedure   @relation(fields: [procedureId], references: [id], onDelete: Cascade)

  @@unique([appointmentId, procedureId])
  @@index([appointmentId])
  @@index([procedureId])
  @@map("appointment_procedures")
}

/// Despesa (Expense) - Gerenciamento de gastos do sistema
model Expense {
  id          String   @id @default(uuid())
  
  // Dados da despesa
  payment     String   // Tipo de pagamento (ex: "Aluguel", "Salário", "Energia", etc.)
  value       Decimal  @db.Decimal(10, 2) // Valor da despesa
  date        DateTime @db.Date // Data do pagamento
  category    String   // Categoria da despesa (ex: "Infraestrutura", "Pessoal", "Operacional")
  
  // Campos técnicos
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([category])
  @@map("expenses")
}
